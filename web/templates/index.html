{{ define "index" }}
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{{ if .Title }}{{ .Title }}{{ else }}{{ .Name }}{{ end }} â€“ Laebel</title>
        <meta name="description"
              content="Documentation site for {{ if .Title }}{{ .Title }}{{ else }}{{ .Name }}{{ end }}. {{ .Description }}">
        <link rel="stylesheet" href="/static/css/styles.css">
        <link rel="icon" type="image/png" href="/static/img/laebel.svg">
    </head>
    <body hx-ext="sse" sse-connect="/events?stream=updates" sse-close="close">
    <header>
        <h1>
            {{ if .Logo }}<img src="{{ .Logo }}" alt="{{ .Name }} logo" width="32px" height="32px">{{ end }}
            {{ if .Title }}{{ .Title }}{{ else }}<code>{{ .Name }}</code>{{ end }}
        </h1>
        {{ if .Description }}<p>{{ .Description }}</p>{{ end }}
        {{ if .Links }}
            <p>
                <strong>Links</strong>:
                {{ range $index, $link := .Links }}{{ if $index }},
                {{ end }}<a href="{{ $link.URL }}">{{ $link.Title }}</a>{{end}}
            </p>
        {{ end }}
    </header>
    <main>
        <section id="sse-error" class="notice" style="display: none;">
            <h2>Failed to update status</h2>
            <p>Cannot connect to the status update endpoint. Is the Laebel service running?</p>
            <p class="cta"><a href=".">Please reload the page to see the updated status.</a></p>
            <script>
                document.body.addEventListener('htmx:sseError', () => {
                    // Show the error message after a short delay to avoid flickering.
                    setTimeout(() => document.getElementById('sse-error').style.display = 'block', 500);
                })
                document.body.addEventListener('htmx:sseOpen', () => {
                    document.getElementById('sse-error').style.display = 'none';
                })
            </script>
        </section>
        {{ if .ServiceGroups }}
            <section id="graph" hx-trigger="sse:reload" hx-get="/graph.mmd" hx-swap="none" hx-target=".mermaid">
                {{ template "graph" . }}
            </section>
        {{ end }}
        <section id="resources" hx-trigger="sse:reload" hx-get="/resources" hx-swap="innerHTML">
            {{ template "resources" . }}
        </section>
    </main>
    <footer>
        <p>
            <a href="https://github.com/henrikje/laebel"><img src="/static/img/laebel.svg" alt="Laebel logo"
                                                              width="32px" height="32px"></a>
            This documentation site is generated by <a href="https://github.com/henrikje/laebel">Laebel</a>.
        </p>
    </footer>
    </body>
    <script src="/static/js/htmx.min.js"></script>
    <script src="/static/js/sse.js"></script>
    <script type="module">
        // Load Mermaid and initialize it
        import mermaid from '/static/js/mermaid.esm.min.mjs';
        mermaid.initialize();

        // Render Mermaid diagrams when they are swapped in
        document.body.addEventListener('htmx:beforeSwap', async (event) => {
            if (event.target.className.includes("mermaid")) {
                event.stopPropagation();
                // Get the Mermaid source from the response
                let mermaidSource = event.detail.xhr.responseText;
                // Render the Mermaid source to an SVG
                const result = await mermaid.render("graph-" + new Date().getTime(), mermaidSource);
                // Update the target element with the rendered SVG
                event.target.innerHTML = result.svg;
            }
        });
    </script>
    <script>
        function copyPreviousText(button) {
            const previousElement = button.previousElementSibling;
            if (previousElement) {
                const text = previousElement.textContent;
                navigator.clipboard.writeText(text)
            }
        }
    </script>
    </html>
{{ end }}